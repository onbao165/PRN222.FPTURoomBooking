@page "/User"
@rendermode InteractiveServer
@using Microsoft.AspNetCore.Authorization
@using PRN222.Assignment.FPTURoomBooking.Services.Models.Account
@using PRN222.Assignment.FPTURoomBooking.Services.Services.Interfaces
@attribute [Authorize(Roles = "Admin")]
@inject IAccountService AccountService
@inject NavigationManager NavigationManager
@inject IJSRuntime JsRuntime

<PageTitle>User Management</PageTitle>

<div class="container mt-4">
    <div class="card">
        <div class="card-header d-flex justify-content-between align-items-center">
            <h3>User List</h3>
            <button class="btn btn-primary" @onclick="CreateNew">Create New User</button>
        </div>
        <div class="card-body">
            <div class="row mb-3">
                <div class="col-md-6">
                    <div class="input-group">
                        <input type="text" class="form-control" @bind="_searchTerm" @bind:event="oninput"
                               placeholder="Search users...">
                        <button class="btn btn-outline-secondary" @onclick="Search">Search</button>
                    </div>
                </div>
                <div class="col-md-3">
                    <select class="form-select" @bind="_orderBy" @bind:event="onchange"
                            @bind:after="HandleOrderByChange">
                        <option value="email">Email</option>
                        <option value="createdAt">Created Date</option>
                    </select>
                </div>
                <div class="col-md-3">
                    <div class="form-check form-switch">
                        <input class="form-check-input" type="checkbox" @bind="_isDescending" @bind:event="onchange"
                               @bind:after="HandleSortDirectionChange">
                        <label class="form-check-label">Descending</label>
                    </div>
                </div>
            </div>

            @if (_loading)
            {
                <div class="text-center">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                </div>
            }
            else if (_users?.Items.Any() == true)
            {
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-dark">
                            <tr>
                                <th>Email</th>
                                <th>Full Name</th>
                                <th>Role</th>
                                <th>Created At</th>
                                <th>Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var user in _users.Items)
                            {
                                <tr>
                                    <td>@user.Email</td>
                                    <td>@user.FullName</td>
                                    <td>@user.Role</td>
                                    <td>@user.CreatedAt.ToString("yyyy-MM-dd")</td>
                                    <td>
                                        <button class="btn btn-sm btn-info me-2" @onclick="() => ViewDetails(user.Id)">
                                            Details
                                        </button>
                                        <button class="btn btn-sm btn-danger" @onclick="() => DeleteUser(user.Id)">
                                            Delete
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>

                <nav>
                    <ul class="pagination">
                        @if (_users?.HasPreviousPage == true)
                        {
                            <li class="page-item">
                                <button class="page-link" @onclick="() => LoadUsers(_pageNumber - 1)">Previous</button>
                            </li>
                        }

                        @for (var i = 1; i <= _users?.TotalPages; i++)
                        {
                            var pageNumber = i;
                            <li class="page-item @(pageNumber == _pageNumber ? "active" : "")">
                                <button class="page-link" @onclick="() => LoadUsers(pageNumber)">@pageNumber</button>
                            </li>
                        }

                        @if (_users?.HasNextPage == true)
                        {
                            <li class="page-item">
                                <button class="page-link" @onclick="() => LoadUsers(_pageNumber + 1)">Next</button>
                            </li>
                        }
                    </ul>
                </nav>
            }
            else
            {
                <div class="alert alert-info">
                    No users found.
                </div>
            }
        </div>
    </div>
</div>

@code {
    private Services.Utils.PaginationResult<AccountModel>? _users;
    private bool _loading = true;
    private string _searchTerm = "";
    private string _orderBy = "email";
    private bool _isDescending;
    private int _pageNumber = 1;
    private const int _pageSize = 10;

    protected override void OnInitialized()
    {
        _pageNumber = 1;
        _searchTerm = "";
        _orderBy = "email";
        _isDescending = false;
    }

    protected override async Task OnInitializedAsync()
    {
        await LoadUsers(_pageNumber);
    }

    private void UpdateUrl()
    {
        var queryParameters = new Dictionary<string, object?>();

        if (!string.IsNullOrWhiteSpace(_searchTerm))
        {
            queryParameters.Add("searchTerm", _searchTerm);
        }

        if (_orderBy != "email")
        {
            queryParameters.Add("orderBy", _orderBy);
        }

        if (_isDescending)
        {
            queryParameters.Add("isDescending", _isDescending);
        }

        if (_pageNumber > 1)
        {
            queryParameters.Add("pageNumber", _pageNumber);
        }

        queryParameters.Add("pageSize", _pageSize);

        var uri = NavigationManager.GetUriWithQueryParameters(queryParameters);
        NavigationManager.NavigateTo(uri);
    }

    private async Task LoadUsers(int pageNumber)
    {
        try
        {
            _loading = true;
            var result = await AccountService.GetPagedAsync(new GetAccountModel
            {
                PageNumber = pageNumber,
                PageSize = _pageSize,
                SearchTerm = _searchTerm,
                OrderBy = _orderBy,
                IsDescending = _isDescending
            });

            if (result.IsSuccess)
            {
                _users = result.Data;
                _pageNumber = pageNumber;
                UpdateUrl();
            }
            else
            {
                Console.WriteLine("Failed to load: " + result.Error);
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine("Error: " + ex.Message);
        }
        finally
        {
            _loading = false;
        }
    }

    private async Task Search()
    {
        _pageNumber = 1;
        await LoadUsers(1);
    }

    private async Task HandleOrderByChange()
    {
        _pageNumber = 1;
        await LoadUsers(1);
    }

    private async Task HandleSortDirectionChange()
    {
        _pageNumber = 1;
        await LoadUsers(1);
    }

    private void CreateNew()
    {
        NavigationManager.NavigateTo("/User/Create");
    }

    private void ViewDetails(Guid id)
    {
        NavigationManager.NavigateTo($"/User/{id}");
    }

    private async Task DeleteUser(Guid id)
    {
        if (!await JsRuntime.InvokeAsync<bool>("confirm", "Are you sure you want to delete this user?"))
            return;

        var result = await AccountService.DeleteAsync(id);
        if (result.IsSuccess)
        {
            await LoadUsers(_pageNumber);
        }
    }
}